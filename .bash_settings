#!/bin/bash
# vim:softtabstop=4:ts=4:sw=4:expandtab:tw=120

# Pulled manually out of .bashrc after doing conda setup
if [ -d $HOME/anaconda3 ]; then
    # >>> conda initialize >>>
    # !! Contents within this block are managed by 'conda init' !!
    __conda_setup="$('$HOME/anaconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "$HOME/anaconda3/etc/profile.d/conda.sh" ]; then
            . "$HOME/anaconda3/etc/profile.d/conda.sh"
        else
            export PATH="$HOME/anaconda3/bin:$PATH"
        fi
    fi
    unset __conda_setup
    # <<< conda initialize <<<
fi

if [[ -v "TERM" && ( "$TERM" == "linux" || "$TERM" == "xterm" ) ]] ; then
    # Its either not defined or its defined to xterm or linux
    export TERM=xterm-256color
fi

# history settings
export HISTTIMEFORMAT='%F %T '
export HISTCONTROL=ignoredups:erasedups  # no duplicate entries
export HISTSIZE=4096                     # custom history size
export HISTFILESIZE=100000               # custom history file size
shopt -s histappend                      # append to history, don't overwrite it

# Global Unix type paths 
export PATH=$PATH:.
export PATH=$PATH:$HOME/settings
export PATH=$PATH:$HOME/scripts
export PATH=$PATH:$HOME/.local/bin
export PATH=$PATH:$HOME/.cargo/bin

if [ "$(uname)" == "Darwin" ]; then
    # Setup JAVA environment variables
    export JAVA_HOME="/System/Library/Frameworks/JavaVM.framework/Versions/Current"
    export PATH=$PATH:$JAVA_HOME/Commands
    # Setup C++ environment variables
    export PATH=$PATH:/usr/local/Cellar/llvm/9.0.1/bin
    export LD_LIBRARY_PATH=/usr/local/Cellar/llvm/9.0.1/lib:$LD_LIBRARY_PATH
    # Setup Python-3.7 environment variables
    export PATH=$PATH:$HOME/Library/Python/3.7/bin
    # Setup MacVim environment variables
    export PATH=/Applications/MacVim.app/Contents/bin:$PATH
    # Setup MacVim as the editor of choice
    if [ -n $SSH_CONNECTION ]; then
        export EDITOR='vim'
    else
        export EDITOR='mvim -f --nomru -c "au VimLeave * !open -a Terminal"'
    fi
elif [ "$(uname -s)" == "Linux" ]; then
    # Setup JAVA environment variables
    export JAVA_HOME="/usr/lib/jvm/java-11-openjdk-amd64"
    export PATH=$PATH:$JAVA_HOME/bin
    # Setup nix-env environment variables
    export PATH=$PATH:$HOME/.nix-profile/bin
    # Setup vim as the editor of choice
    export EDITOR='vim'
fi

# Setup the bat (replacement for cat) settings
export BAT_CONFIG_PATH=$HOME/.config/bat/bat.conf
export BAT_THEME="zenburn"
export BAT_PAGER="less -RFX"
export PAGER="less -RFX"

# RipGrep needs to know where its configuration file is located
export RIPGREP_CONFIG_PATH=$HOME/.config/ripgrep/.ripgreprc

# Setup golang environment variables
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin

if [ "$(uname)" == "Darwin" ]; then

    # if using MacOS Catalina then the command prompt will issue a message about switching to zsh -- silence this!
    MACOS_CATALINA_MINOR_VER=15
    macos_minor_ver=$(sw_vers -productVersion | awk -F. '{print $2}')
    if [[ "$macos_minor_ver" -ge "$MACOS_CATALINA_MINOR_VER" ]]; then
        export BASH_SILENCE_DEPRECATION_WARNING=1
        #echo "In macos Catalina and silencing the deprication warning"
    #else
        #echo "In macos before Catalina and not deprecating the warning"
    fi

    export PROMPT_COMMAND='echo -ne "\033]0;${PWD/#$HOME/~}\007"'

    # add bash_completion when in Mac using the $(brew --prefix) path
    if [ -e /usr/local/bin/brew ]; then
        if [ -f $(brew --prefix)/etc/bash_completion ]; then
            . $(brew --prefix)/etc/bash_completion
        fi
    fi
   
    # add git-completion to the environment
    if [ -f $HOME/settings/git-completion.bash ]; then
        . $HOME/settings/git-completion.bash
    fi

    # add gem home location so sudo access isn't required
    #export GEM_HOME=$HOME/.gem
    #export PATH="$GEM_HOME/bin:$PATH"

elif [ "$(uname -s)" == "Linux" ]; then

    # prompt_command is a callback which is called right before the prompt is printed
    # this sets the tab title to the current working directory in iTerm2
    if [ "$(lsb_release -sc)" == "precise" ]; then
        export PROMPT_COMMAND='echo -ne "\033]0;${PWD/#$HOME/~}\007"'
    else
        export PROMPT_COMMAND='echo -ne "\033]0;${PWD/#$HOME/\~}\007"'
    fi

fi

# functions to set the color of the tab in iTerm2
function tab-blank() { echo -n -e "\033]6;1;bg;*;default\a" ; }
function tab-lime() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;green;brightness;255\a" ; }
function tab-red() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;255\a" ; }
function tab-blue() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;blue;brightness;255\a" ; }
function tab-yellow() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;255\a\033]6;1;bg;green;brightness;255\a\033]6;1;bg;blue;brightness;0\a" ; }
function tab-purple() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;255\a\033]6;1;bg;green;brightness;0\a\033]6;1;bg;blue;brightness;255\a" ; }
function tab-orange() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;255\a\033]6;1;bg;green;brightness;128\a\033]6;1;bg;blue;brightness;0\a" ; }
function tab-aqua() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;0\a\033]6;1;bg;green;brightness;255\a\033]6;1;bg;blue;brightness;255\a" ; }
function tab-redder() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;128\a\033]6;1;bg;green;brightness;0\a\033]6;1;bg;blue;brightness;0\a" ; }
function tab-olive() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;128\a\033]6;1;bg;green;brightness;128\a\033]6;1;bg;blue;brightness;0\a" ; }
function tab-green() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;0\a\033]6;1;bg;green;brightness;128\a\033]6;1;bg;blue;brightness;0\a" ; }
function tab-teal() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;0\a\033]6;1;bg;green;brightness;128\a\033]6;1;bg;blue;brightness;128\a" ; }
function tab-navy() { echo -n -e "\033]6;1;bg;*;default\a\033]6;1;bg;red;brightness;0\a\033]6;1;bg;green;brightness;0\a\033]6;1;bg;blue;brightness;128\a" ; }

# setting the PS1 environment variable will set the prompt to a specific color and the working directory
function set_prompt {
    local BLACK="\[\033[0;30m\]"
    local BLACKBOLD="\[\033[1;30m\]"
    local RED="\[\033[0;31m\]"
    local REDBOLD="\[\033[1;31m\]"
    local GREEN="\[\033[0;32m\]"
    local GREENBOLD="\[\033[1;32m\]"
    local YELLOW="\[\033[0;33m\]"
    local YELLOWBOLD="\[\033[1;33m\]"
    local BLUE="\[\033[0;34m\]"
    local BLUEBOLD="\[\033[1;34m\]"
    local PURPLE="\[\033[0;35m\]"
    local PURPLEBOLD="\[\033[1;35m\]"
    local CYAN="\[\033[0;36m\]"
    local CYANBOLD="\[\033[1;36m\]"
    local WHITE="\[\033[0;37m\]"
    local WHITEBOLD="\[\033[1;37m\]"
    local RESETCOLOR="\[\e[00m\]"

    export PS1="$BLUE\w$RED"'$(vcprompt -n -f %s:%b[%a%m%u])'"$BLUE â†’ $RESETCOLOR"
}

if [ "$(uname -s)" == "Linux" ]; then
    test -r $HOME/.dircolors && eval "$(dircolors $HOME/.dircolors)"
fi

function set_cscope {
    eval `find . -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' > ./cscope.files`
    eval `cscope -b`
}

function move_into_dev {
    cd $HOME/dev/$@
}

function set_tab_color {
    if [ -e "$HOME/settings/.bash_color" ]; then
        tab-$(head -n 1 $HOME/settings/.bash_color)
    fi
}

get_network_info() {
    if [ -e "$HOME/scripts/network_info.py" ]; then
        python3 $HOME/scripts/network_info.py
    fi
}

get_weather_info() {
    if [ -e "$HOME/scripts/weather_info.py" ]; then
        python3 $HOME/scripts/weather_info.py
    fi
}

get_full_weather_info() {
    if [ -e "$HOME/scripts/weather_info.py" ]; then
        python3 $HOME/scripts/weather_info.py --full-report
    fi
}

# User specific aliases and functions
alias settings="vim $HOME/settings/.bash_settings"
alias zsettings="vim $HOME/settings/.zshrc"
alias setting-dir="cd $HOME/settings"
alias x="exit"
alias df="df -h"
alias cp="cp -i"
alias mv="mv -i"
alias rm="rm -i"
alias ide="vim -O3"
alias cpwp="rsync -aP"
alias mvwp="rsync -aP --remove-source-files"
alias update-path="export PATH=$PATH:`pwd`"
alias brewup="brew update; brew upgrade; brew prune; brew cleanup; brew doctor"
alias pylint="pylint -r n --rcfile=~/settings/pylintrc"
alias set-cscope=set_cscope
alias setup-intel="source /opt/intel/bin/iccvars.sh -arch intel64 -platform linux"
alias update="sudo apt-get update"
alias upgrade="sudo apt-get dist-upgrade"
alias dev=move_into_dev
alias devprep="ctags -R > /dev/null 2>&1; yes | cp -vf $HOME/dev/.ycm_extra_conf.py . > /dev/null 2>&1; yes | cp -vf $HOME/dev/.color_coded . > /dev/null 2>&1"
alias set-tab-color=set_tab_color
alias matrix="cmatrix -bs -C red"
alias weather=get_full_weather_info
alias netinfo=get_network_info
alias gitls="bash $HOME/settings/gitls/gitls"
alias 7zenc="7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=32m -ms=on -mhe=on -p"
alias 7ztest="7z l -slt"
alias 7zdec="7z x"
alias transmission-cli="transmission-remote-cli --config=$HOME/.transmission-remote-cli.config"
alias cls="clear && echo -en \"\e[3J\""
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias .....="cd ../../../.."
alias ......="cd ../../../../.."
alias .......="cd ../../../../../.."
alias ........="cd ../../../../../../.."
alias .........="cd ../../../../../../../.."
alias ..........="cd ../../../../../../../../.."

# special git diff alias to use my custom difftool
alias gd="PAGER='less -RF' git difftool"

if [ $(command -v exa) ]; then
    # The default 'ls -l -a' but also adding the header, showing the date nicely and showing git status
    alias ls="unbuffer exa --all --long --header --group --sort=.Name --time-style=long-iso --git --icons"
    # List all the files sorting by modified date, reversing the order, to show the newest on top
    alias lst="unbuffer exa --all --long --header --group --sort=oldest --time-style=long-iso --git --icons"
    # The default 'ls -l -a' but also adding the header, showing the date nicely and showing git status
    alias dir="unbuffer exa --all --long --header --group --sort=CName --time-style=long-iso --git --icons"
else
    # The default 'ls -l -a'
    alias ls="ls -l --all --color=always --time-style=long-iso --classify --human-readable"
    # List all the files sorting by modified date to show the newest on top
    alias lst="ls -l --all --color=always --time-style=long-iso --classify --human-readable -t"
    # The default 'ls -l -a'
    alias dir="ls -l --all --color=always --time-style=long-iso --classify --human-readable"
fi

if [ -e "$HOME/settings/.ssh_aliases" ]; then
    source $HOME/settings/.ssh_aliases
fi

set_tab_color
set_prompt
get_network_info
get_weather_info
